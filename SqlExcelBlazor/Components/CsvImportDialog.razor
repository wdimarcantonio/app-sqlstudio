@using SqlExcelBlazor.Models

<div class="modal-backdrop" @onclick="Cancel"></div>
<div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ðŸ“„ Importa CSV</h3>
            <button class="btn-close" @onclick="Cancel">âœ–</button>
        </div>
        
        <div class="modal-body">
            <div class="form-group">
                <label>File</label>
                <div class="file-name">@FileName</div>
            </div>

            <div class="form-group">
                <label>Separatore</label>
                <select class="form-select" @bind="separator">
                    <option value=";">Punto e virgola (;)</option>
                    <option value=",">Virgola (,)</option>
                    <option value="\t">Tabulazione (\t)</option>
                    <option value="|">Pipe (|)</option>
                </select>
            </div>

            <div class="form-group">
                <label>Nome Tabella (Alias)</label>
                <input type="text" class="form-input" @bind="tableAlias" />
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-primary" @onclick="Confirm">Importa</button>
        </div>
    </div>
</div>

@code {
    [Parameter] public string FileName { get; set; } = "";
    [Parameter] public EventCallback<(string Alias, string Separator)> OnConfirm { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private string separator = ";";
    private string tableAlias = "";

    protected override void OnInitialized()
    {
        tableAlias = GenerateAlias(FileName);
    }

    private void Confirm()
    {
        if (string.IsNullOrWhiteSpace(tableAlias)) return;
        OnConfirm.InvokeAsync((tableAlias, separator));
    }
    
    private void Cancel()
    {
        OnCancel.InvokeAsync();
    }
    
    private string GenerateAlias(string name)
    {
        var cleanName = Path.GetFileNameWithoutExtension(name);
        var alias = new string(cleanName.Where(c => char.IsLetterOrDigit(c) || c == '_').ToArray());
        if (string.IsNullOrEmpty(alias)) alias = "Table";
        return alias;
    }
}
