@using SqlExcelBlazor.Models
@using SqlExcelBlazor.Services
@using Microsoft.AspNetCore.Components.Web.Virtualization
@inject SqlServerClientService SqlService
@inject AppState AppState
@inject SqliteApiClient SqliteApi

<div class="modal-backdrop" @onclick="Close"></div>
<div class="modal-dialog" style="max-width: 900px; width: 95%;">
    <div class="modal-content" style="height: 80vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <h3>üîó Connetti a SQL Server</h3>
            <button class="btn-close" @onclick="Close">‚úñ</button>
        </div>
        
        <div class="modal-body" style="flex: 1; overflow: hidden; display: flex; flex-direction: column; padding: 0;">
            @if (step == 1)
            {
                <div class="connection-form" style="padding: 1rem; overflow-y: auto;">
                    <div class="form-group">
                        <label>Server Instance</label>
                        <input type="text" class="form-input" @bind="server" placeholder="es. localhost oppure 192.168.1.10" />
                    </div>
                    
                    <div class="form-group">
                        <label>Nome Database</label>
                        <input type="text" class="form-input" @bind="database" placeholder="es. MyDatabase" />
                    </div>
                    
                    <div class="form-group">
                        <label>Autenticazione</label>
                        <select class="form-select" @bind="authType">
                            <option value="sql">SQL Server Authentication</option>
                            <option value="windows">Windows Authentication (Integrated)</option>
                        </select>
                    </div>
                    
                    @if (authType == "sql")
                    {
                        <div class="form-row" style="display: flex; gap: 1rem;">
                            <div class="form-group" style="flex: 1;">
                                <label>Username</label>
                                <input type="text" class="form-input" @bind="username" />
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Password</label>
                                <input type="password" class="form-input" @bind="password" />
                            </div>
                        </div>
                    }

                    <div class="form-group checkbox-group" style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                        <input type="checkbox" id="trustCert" @bind="trustServerCert" />
                        <label for="trustCert" style="margin:0; cursor: pointer;">Trust Server Certificate (utile in dev)</label>
                    </div>
                    
                    <div class="error-text">@errorMessage</div>
                </div>
                
                 <div class="modal-footer" style="padding: 1rem; border-top: 1px solid #ddd;">
                    <button class="btn btn-primary" @onclick="Connect" disabled="@isLoading">
                        @if (isLoading) { <span>‚è≥ Connessione...</span> } else { <span>Connetti e Seleziona Tabelle</span> }
                    </button>
                </div>
            }
            else if (step == 2)
            {
                <div class="table-selection" style="display: flex; flex-direction: column; height: 100%;">
                    <div class="search-box" style="padding: 1rem; border-bottom: 1px solid #eee;">
                        <input type="text" class="form-input" @bind="searchTerm" @bind:event="oninput" @onkeyup="FilterTree" placeholder="üîç Cerca tabella..." />
                    </div>
                    
                    <div class="tree-header" style="display: flex; padding: 0.5rem 1rem; background: #f8f9fa; border-bottom: 1px solid #ddd; font-weight: bold;">
                        <div style="flex: 2;">Oggetto</div>
                        <div style="flex: 1;">Alias (Modificabile)</div>
                    </div>

                    <div class="schema-tree" style="flex: 1; overflow-y: auto;">
                        <Virtualize Items="@visibleItems" Context="item" ItemSize="35">
                            <div class="tree-row @(item.IsSelected ? "selected" : "")" style="padding-left: @(item.Depth * 20)px; display: flex; align-items: center; border-bottom: 1px solid #f0f0f0; height: 35px;">
                                @if (!item.IsLeaf)
                                {
                                    <span @onclick="() => ToggleExpand(item)" style="cursor: pointer; width: 20px; display: inline-block; text-align: center;">
                                        @(item.IsExpanded ? "‚ñº" : "‚ñ∂")
                                    </span>
                                    <span class="icon">@(item.GroupType == "Type" ? "üìÅ" : "üìÇ")</span>
                                    <span style="font-weight: 500; margin-left: 5px;">@item.Label</span>
                                }
                                else
                                {
                                    <div class="table-check" style="flex: 2; display: flex; align-items: center; margin-left: 20px;">
                                        <input type="checkbox" @bind="item.Data.IsSelected" id="chk_@item.Data.FullName" style="margin-right: 8px;" />
                                        <label for="chk_@item.Data.FullName" style="margin: 0; cursor: pointer; display: flex; align-items: center;">
                                            <span class="icon" style="margin-right: 5px;">@(item.Data.Type == "VIEW" ? "üëÅÔ∏è" : "üìÖ")</span>
                                            @item.Data.Name
                                        </label>
                                    </div>
                                    <div style="flex: 1; padding-right: 10px;">
                                        @if (item.Data.IsSelected)
                                        {
                                            <input type="text" class="alias-input form-control form-control-sm" @bind="item.Data.Alias" />
                                        }
                                    </div>
                                }
                            </div>
                        </Virtualize>
                    </div>
                    
                    <div class="modal-footer" style="padding: 1rem; border-top: 1px solid #ddd;">
                        <div style="margin-right: auto;">
                            Selezionate: @tables.Count(t => t.IsSelected)
                        </div>
                        <button class="btn btn-secondary" @onclick="() => step = 1">‚¨Ö Indietro</button>
                        <button class="btn btn-primary" @onclick="ImportSelected" disabled="@(!tables.Any(t => t.IsSelected) || isLoading)">
                            @if (isLoading) { <span>‚è≥ Importazione...</span> } else { <span>Importa Selezionati</span> }
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public EventCallback OnClose { get; set; }
    
    // Connection Form Fields
    private string server = "localhost";
    private string database = "";
    private string authType = "sql"; // "sql" or "windows"
    private string username = "sa";
    private string password = "";
    private bool trustServerCert = true;

    private int step = 1;
    private string connectionString = "";
    private string errorMessage = "";
    private bool isLoading = false;
    private List<LocalSchemaItem> tables = new();
    private string searchTerm = "";
    
    // Tree View State
    private List<TreeItem> visibleItems = new();
    private List<TreeItem> allItems = new();

    private class TreeItem
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string Label { get; set; } = "";
        public int Depth { get; set; }
        public bool IsExpanded { get; set; } // Default expanded for now?
        public bool IsLeaf { get; set; }
        public LocalSchemaItem? Data { get; set; }
        public string GroupType { get; set; } = ""; // "Type", "Schema"
        public List<TreeItem> Children { get; set; } = new();
        public bool IsVisible { get; set; } = true;
        
        // Helper per stato selezione visuale (opzionale)
        public bool IsSelected => Data?.IsSelected ?? false;
    }

    private void BuildTree()
    {
        allItems.Clear();
        
        // Group by Type (Table/View) -> Schema
        var byType = tables.GroupBy(t => t.Type == "VIEW" ? "Viste" : "Tabelle")
                           .OrderBy(g => g.Key);

        foreach (var typeGroup in byType)
        {
            var typeNode = new TreeItem 
            { 
                Label = typeGroup.Key, 
                Depth = 0, 
                IsExpanded = true, 
                IsLeaf = false,
                GroupType = "Type"
            };
            allItems.Add(typeNode);

            var bySchema = typeGroup.GroupBy(t => t.Schema).OrderBy(g => g.Key);
            
            foreach (var schemaGroup in bySchema)
            {
                var schemaNode = new TreeItem
                {
                    Label = schemaGroup.Key,
                    Depth = 1,
                    IsExpanded = false, // Schemas collapsed by default?
                    IsLeaf = false,
                    GroupType = "Schema"
                };
                typeNode.Children.Add(schemaNode);
                
                foreach (var table in schemaGroup.OrderBy(t => t.Name))
                {
                    // Default alias con schema
                    if (string.IsNullOrEmpty(table.Alias))
                    {
                        table.Alias = $"{table.Schema}.{table.Name}";
                    }
                    
                    var tableNode = new TreeItem
                    {
                        Label = table.Name,
                        Depth = 2,
                        IsLeaf = true,
                        Data = table
                    };
                    schemaNode.Children.Add(tableNode);
                }
            }
        }
        
        UpdateVisibleItems();
    }

    private void ToggleExpand(TreeItem item)
    {
        item.IsExpanded = !item.IsExpanded;
        UpdateVisibleItems();
    }
    
    private void UpdateVisibleItems()
    {
        visibleItems.Clear();
        // Flatten tree honoring expansion state
        foreach (var node in allItems)
        {
            AddNodeToVisible(node);
        }
    }
    
    private void AddNodeToVisible(TreeItem node)
    {
        // Se c'√® ricerca, mostra tutto ci√≤ che matcha
        bool isFiltering = !string.IsNullOrWhiteSpace(searchTerm);
        
        if (isFiltering)
        {
             // Logica semplice: se √® foglia e matcha, mostra. 
             // Se √® nodo e ha figli che matchano, mostra ed espandi.
             // Questo richiederebbe una pre-analisi. 
             // Per ora, manteniamo la logica semplice: ricostruzione piatta
             // Ma FilterTree viene chiamato al cambio ricerca.
        }
        
        visibleItems.Add(node);
        
        if (node.IsExpanded)
        {
            foreach (var child in node.Children)
            {
                AddNodeToVisible(child);
            }
        }
    }

    private void FilterTree()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            // Reset to clean tree
            BuildTree();
            return;
        }

        // Filter logic: create temporary tree with matching nodes
        visibleItems.Clear();
        
        var term = searchTerm.Trim();
        
        foreach (var typeNode in allItems)
        {
            // Check if any children match
            var matchingSchemas = new List<TreeItem>();
            foreach (var schemaNode in typeNode.Children)
            {
                var matchingTables = schemaNode.Children
                    .Where(t => t.Data!.Name.Contains(term, StringComparison.OrdinalIgnoreCase) || 
                                t.Data!.Schema.Contains(term, StringComparison.OrdinalIgnoreCase))
                    .ToList();
                
                if (matchingTables.Any())
                {
                     // Clone schema node to avoid modifying original structure state
                     var schemaClone = new TreeItem 
                     { 
                         Label = schemaNode.Label, 
                         Depth = 1, 
                         IsExpanded = true, 
                         IsLeaf = false, 
                         GroupType = "Schema",
                         Children = matchingTables // Share table nodes
                     };
                     matchingSchemas.Add(schemaClone);
                }
            }
            
            if (matchingSchemas.Any())
            {
                var typeClone = new TreeItem
                {
                    Label = typeNode.Label,
                    Depth = 0,
                    IsExpanded = true,
                    IsLeaf = false,
                    GroupType = "Type",
                    Children = matchingSchemas
                };
                
                // Add flat
                visibleItems.Add(typeClone);
                foreach (var s in matchingSchemas)
                {
                    visibleItems.Add(s);
                    visibleItems.AddRange(s.Children);
                }
            }
        }
    }

    private void BuildConnectionString()
    {
        var parts = new List<string>();
        parts.Add($"Server={server}");
        parts.Add($"Database={database}");
        parts.Add($"TrustServerCertificate={(trustServerCert ? "True" : "False")}");

        if (authType == "windows")
        {
            parts.Add("Integrated Security=True");
        }
        else
        {
            parts.Add($"User Id={username}");
            parts.Add($"Password={password}");
            parts.Add("Integrated Security=False");
        }
        
        connectionString = string.Join(";", parts);
    }

    private async Task Connect()
    {
        try 
        {
            if (string.IsNullOrWhiteSpace(server)) throw new Exception("Il campo Server √® obbligatorio.");
            if (string.IsNullOrWhiteSpace(database)) throw new Exception("Il campo Database √® obbligatorio.");
            
            BuildConnectionString();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            return;
        }

        isLoading = true;
        errorMessage = "";
        
        try
        {
            var serverItems = await SqlService.GetTables(connectionString);
            tables = serverItems.Select(i => new LocalSchemaItem 
            { 
                Schema = i.Schema, 
                Name = i.Name, 
                Type = i.Type,
                Alias = $"{i.Schema}.{i.Name}" // Default alias con schema
            }).ToList();
            
            BuildTree();
            step = 2;
        }
        catch (Exception ex)
        {
            errorMessage = $"Errore di connessione: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private async Task ImportSelected()
    {
        isLoading = true;
        try
        {
            var selected = tables.Where(t => t.IsSelected).ToList();
            int importedCount = 0;

            foreach (var table in selected)
            {
                var query = $"SELECT * FROM [{table.Schema}].[{table.Name}]";
                var result = await SqlService.ExecuteQuery(connectionString, query);
                
                var finalAlias = string.IsNullOrWhiteSpace(table.Alias) ? $"{table.Schema}.{table.Name}" : table.Alias;
                
                // 1. Update Persistent storage (SQLite)
                if (AppState.UseSqliteBackend)
                {
                    var uploadResult = await SqliteApi.UploadJsonAsync(
                        finalAlias, // Use Alias as TableName in SQLite
                        result.Columns,
                        result.Rows
                    );
                    
                    if (!uploadResult.Success)
                    {
                        throw new Exception($"Errore salvataggio {table.Name}: {uploadResult.ErrorMessage}");
                    }
                }

                // 2. Update InMemory State (AppState) -> This links the UI to the data
                // Note: If using SQLite backend, Data property might be empty or used for preview?
                // AppState.AddDataSource uses the Data property for local query engine.
                // If UseSqliteBackend is true, AppState should ideally behave differently, 
                // but for now we maintain compatibility by populating it. 
                // However, for large tables this is memory intensive.
                // Given the user requirement is about "importing", storing in SQLite is the key.
                // We will create a light DataSource object.

                // Convert rows to Dictionary<string, string> for DataSource compatibility
                var displayData = result.Rows.Select(r => r.ToDictionary(k => k.Key, v => v.Value?.ToString() ?? "")).ToList();

                var dataSource = new DataSource
                {
                    Name = table.Name,
                    Type = DataSourceType.SqlServer,
                    TableAlias = finalAlias,
                    Columns = result.Columns,
                    RowCount = result.Rows.Count,
                    Data = displayData, 
                    IsLoaded = true
                };
                
                AppState.AddDataSource(dataSource);
                importedCount++;
            }
            
            AppState.StatusMessage = $"Importate {importedCount} tabelle da SQL Server";
            await Close();
        }
        catch (Exception ex)
        {
            errorMessage = $"Errore importazione: {ex.Message}";
            StateHasChanged(); // Force UI update to show error
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }
}

