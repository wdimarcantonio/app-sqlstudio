@using SqlExcelBlazor.Models
@using SqlExcelBlazor.Services
@inject AppState AppState
@inject SqliteApiClient SqliteApi
@inject IJSRuntime JS

<div class="tab-panel">
    <div class="panel-stack">
        <!-- Editor Query -->
        <div class="card">
            <h2>üìù Query SQL</h2>
            
            <MonacoSqlEditor @bind-Value="AppState.SqlQuery" 
                             DataSources="@AppState.DataSources"
                             Height="300px"
                             Theme="vs-dark" />
            
            <div class="query-actions">
                <button class="btn btn-primary btn-lg" @onclick="ExecuteQueryAsync">
                    ‚ñ∂Ô∏è Esegui Query (SQLite)
                </button>
                <span class="tables-info">@AppState.GetLoadedTablesInfo()</span>
            </div>
        </div>
        
        <!-- Risultati -->
        <div class="card">
            <div class="results-header">
                <h2>üìä Risultati</h2>
                @if (AppState.LastResult?.IsSuccess == true)
                {
                    <span class="results-info">
                        @AppState.LastResult.RowCount righe | @AppState.LastResult.ColumnCount colonne | 
                        @AppState.LastResult.ExecutionTime.TotalMilliseconds.ToString("F2")ms
                    </span>
                }
            </div>
            
            @if (AppState.LastResult == null)
            {
                <div class="empty-state">
                    <p>Esegui una query per visualizzare i risultati</p>
                </div>
            }
            else if (!AppState.LastResult.IsSuccess)
            {
                <div class="error-message">
                    <strong>Errore:</strong> @AppState.LastResult.ErrorMessage
                </div>
            }
            else
            {
                <div style="height: 500px;">
                    <AdvancedDataGrid 
                        Columns="@AppState.LastResult.Columns" 
                        Rows="@ConvertRowsToStringDictionary(AppState.LastResult.Rows)" 
                        TotalCount="@AppState.LastResult.Rows.Count"
                        State="@executionGridState"
                        OnStateChanged="@HandleGridStateChange" />
                </div>
                
                <!-- Export Buttons -->
                <div class="export-actions">
                    <button class="btn btn-secondary" @onclick="ExportExcel">
                        üìó Esporta Excel
                    </button>
                    <button class="btn btn-secondary" @onclick="ExportCsv">
                        üìÑ Esporta CSV
                    </button>
                    <button class="btn btn-secondary" @onclick="ExportSqlScript">
                        üóÑÔ∏è Script SQL
                    </button>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private async Task ExecuteQueryAsync()
    {
        // Inject SqliteApi into AppState if not set
        AppState.SqliteApi = SqliteApi;
        await AppState.ExecuteQueryWithSqliteAsync();
        CurrentPage = 1; // Reset pagination on new query
        executionGridState = new GridState(); // Reset grid state
    }

    // Pagination Logic (no longer used with AdvancedDataGrid, kept for compatibility)
    private int CurrentPage { get; set; } = 1;
    private int PageSize { get; set; } = 50;

    private int TotalPages => AppState.LastResult?.Rows == null || PageSize <= 0 ? 1 : 
        (int)Math.Ceiling(AppState.LastResult.Rows.Count / (double)PageSize);

    private IEnumerable<Dictionary<string, object?>> GetPagedRows()
    {
        if (AppState.LastResult?.Rows == null) return Enumerable.Empty<Dictionary<string, object?>>();
        
        return AppState.LastResult.Rows
            .Skip((CurrentPage - 1) * PageSize)
            .Take(PageSize);
    }

    private void ChangePage(int newPage)
    {
        if (newPage >= 1 && newPage <= TotalPages)
        {
            CurrentPage = newPage;
        }
    }
    
    // Grid state for results
    private GridState executionGridState = new();
    
    // Convert object? dictionaries to string dictionaries for AdvancedDataGrid
    private List<Dictionary<string, string>> ConvertRowsToStringDictionary(List<Dictionary<string, object?>> rows)
    {
        return rows.Select(row => 
            row.ToDictionary(
                kvp => kvp.Key, 
                kvp => kvp.Value?.ToString() ?? ""
            )
        ).ToList();
    }
    
    // Handle grid state changes (sorting, filtering)
    private void HandleGridStateChange(GridState newState)
    {
        executionGridState = newState;
        StateHasChanged();
    }
    
    private async Task ExportExcel()
    {
        if (AppState.LastResult == null || !AppState.LastResult.IsSuccess) return;
        
        try
        {
            var bytes = AppState.ExcelService.GenerateExcel(AppState.LastResult);
            await JS.InvokeVoidAsync("downloadFile", "risultati.xlsx", 
                "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", 
                Convert.ToBase64String(bytes));
            AppState.StatusMessage = "File Excel scaricato";
        }
        catch (Exception ex)
        {
            AppState.StatusMessage = $"Errore export: {ex.Message}";
        }
    }
    
    private async Task ExportCsv()
    {
        if (AppState.LastResult == null || !AppState.LastResult.IsSuccess) return;
        
        try
        {
            var csv = AppState.CsvService.GenerateCsv(AppState.LastResult);
            var bytes = System.Text.Encoding.UTF8.GetBytes(csv);
            await JS.InvokeVoidAsync("downloadFile", "risultati.csv", "text/csv", 
                Convert.ToBase64String(bytes));
            AppState.StatusMessage = "File CSV scaricato";
        }
        catch (Exception ex)
        {
            AppState.StatusMessage = $"Errore export: {ex.Message}";
        }
    }
    
    private async Task ExportSqlScript()
    {
        if (AppState.LastResult == null || !AppState.LastResult.IsSuccess) return;
        
        try
        {
            var sql = AppState.SqlExportService.GenerateInsertScript(AppState.LastResult, "ExportedTable");
            var bytes = System.Text.Encoding.UTF8.GetBytes(sql);
            await JS.InvokeVoidAsync("downloadFile", "script.sql", "text/plain", 
                Convert.ToBase64String(bytes));
            AppState.StatusMessage = "Script SQL scaricato";
        }
        catch (Exception ex)
        {
            AppState.StatusMessage = $"Errore export: {ex.Message}";
        }
    }
}
