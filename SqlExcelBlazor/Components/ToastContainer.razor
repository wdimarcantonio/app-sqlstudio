@using SqlExcelBlazor.Services
@inject NotificationService NotificationService
@implements IDisposable

<div class="toast-container">
    @foreach (var toast in toasts)
    {
        <div class="toast toast-@toast.Type.ToString().ToLower() @(toast.IsVisible ? "show" : "hide")">
            <div class="toast-icon">
                @switch (toast.Type)
                {
                    case NotificationType.Success: <span>✅</span>; break;
                    case NotificationType.Error: <span>❌</span>; break;
                    case NotificationType.Warning: <span>⚠️</span>; break;
                    default: <span>ℹ️</span>; break;
                }
            </div>
            <div class="toast-message">@toast.Message</div>
            <button class="toast-close" @onclick="() => RemoveToast(toast)">✖</button>
        </div>
    }
</div>

@code {
    private List<ToastMessage> toasts = new();

    protected override void OnInitialized()
    {
        NotificationService.OnShow += ShowToast;
    }

    private void ShowToast(string message, NotificationType type)
    {
        // Ensure UI updates happen on the correct thread
        InvokeAsync(async () => 
        {
            var toast = new ToastMessage { Message = message, Type = type, IsVisible = true };
            toasts.Add(toast);
            StateHasChanged();

            // Auto remove after 5 seconds
            await Task.Delay(5000);
            await RemoveToast(toast);
        });
    }

    private async Task RemoveToast(ToastMessage toast)
    {
        await InvokeAsync(async () => 
        {
            if (toasts.Contains(toast))
            {
                toast.IsVisible = false;
                StateHasChanged();
                
                // Remove from list after animation
                await Task.Delay(300);
                
                if (toasts.Contains(toast))
                {
                    toasts.Remove(toast);
                    StateHasChanged();
                }
            }
        });
    }

    public void Dispose()
    {
        NotificationService.OnShow -= ShowToast;
    }

    private class ToastMessage
    {
        public string Message { get; set; } = "";
        public NotificationType Type { get; set; }
        public bool IsVisible { get; set; }
    }
}
