@using SqlExcelBlazor.Models
@using SqlExcelBlazor.Services
@using SqlExcelBlazor.Components.Shared
@inject AppState AppState
@inject SqliteApiClient SqliteApi
@inject IJSRuntime JS

<div class="tab-panel">
    <div class="panel-grid">
        <!-- Lista Origini Dati -->
        <div class="card">
            <h2>ÔøΩÔøΩ Origini Dati Caricate</h2>
            <div class="button-group">
                <label class="btn btn-primary file-input-label">
                    üìó Importa Excel
                    <InputFile OnChange="HandleExcelUpload" accept=".xlsx, .xls" class="file-input" />
                </label>
                <label class="btn btn-secondary file-input-label">
                    üìÑ Importa CSV
                    <InputFile OnChange="HandleCsvUpload" accept=".csv" class="file-input" />
                </label>
                <button class="btn btn-secondary" @onclick="() => showSqlServerDialog = true">
                    üóÑÔ∏è SQL Server
                </button>
            </div>
            
            @if (showSqlServerDialog)
            {
                <SqlServerDialog OnClose="() => showSqlServerDialog = false" />
            }
            
            @if (showExcelDialog)
            {
                <ExcelImportDialog FileId="pendingExcelFileId" 
                                   FileName="@pendingExcelFileName" 
                                   OnImportCompleted="OnExcelImported"
                                   OnCancel="() => showExcelDialog = false" />
            }
            
            @if (!string.IsNullOrEmpty(importWarningMessage))
            {
                <div class="alert alert-warning">
                    @importWarningMessage
                    <button class="btn-close-alert" @onclick="() => importWarningMessage = null">‚úñ</button>
                </div>
            }
            
            @if (showCsvDialog)
            {
                <CsvImportDialog FileName="@(pendingCsvFile?.Name ?? "")"
                                 OnConfirm="OnCsvConfirmed"
                                 OnCancel="() => showCsvDialog = false" />
            }
            
            <div class="data-sources-list">
                @if (AppState.DataSources.Count == 0)
                {
                    <div class="empty-state">
                        <p>Nessuna origine dati caricata.</p>
                        <p>Importa un file Excel o CSV per iniziare.</p>
                    </div>
                }
                else
                {
                    @foreach (var ds in AppState.DataSources)
                    {
                        var localDs = ds; // Capture for closures
                        <div class="data-source-item @(AppState.SelectedDataSource == ds ? "selected" : "")" 
                             @onclick="() => AppState.SelectedDataSource = ds">
                            <div class="ds-header">
                                <span class="ds-icon">üìä</span>
                                <span class="ds-name">@ds.Name</span>
                            </div>
                            <div class="ds-info">
                                <label class="alias-label">Alias:</label>
                                <input type="text" class="alias-input-ds" value="@ds.TableAlias" 
                                       @oninput="@(e => UpdateAliasValue(ds, e.Value?.ToString() ?? ""))" 
                                       @onclick:stopPropagation="true" />
                                @if (pendingRenames.ContainsKey(ds.Id))
                                {
                                    <button class="btn btn-primary btn-sm" @onclick="@(() => ApplyAliasChange(ds))" @onclick:stopPropagation="true">
                                        ‚úì Applica
                                    </button>
                                }
                                <span class="ds-rows">@ds.RowCount righe</span>
                            </div>
                            <button class="btn btn-danger btn-sm" @onclick="() => RemoveDataSource(ds)" @onclick:stopPropagation="true">
                                üóëÔ∏è Rimuovi
                            </button>
                        </div>
                    }
                }
            </div>
            
            @if (AppState.DataSources.Count > 0)
            {
                <button class="btn btn-secondary" @onclick="ClearAll">
                    üóëÔ∏è Rimuovi Tutto
                </button>
            }
        </div>
        
        <!-- Anteprima Dati -->
        <div class="card card-wide">
            <h2>üëÅÔ∏è Anteprima Dati</h2>
            
            @if (AppState.SelectedDataSource != null)
            {
                <p class="file-path">@AppState.SelectedDataSource.Name - [@AppState.SelectedDataSource.TableAlias]</p>
                
                <div class="grid-wrapper-host" style="height: 500px;">
                    <AdvancedDataGrid Columns="@AppState.SelectedDataSource.Columns" 
                                      Rows="@AppState.SelectedDataSource.Data" 
                                      TotalCount="@AppState.SelectedDataSource.RowCount"
                                      State="@AppState.SelectedDataSource.State"
                                      OnStateChanged="@(s => ReloadDataSource(AppState.SelectedDataSource))" />
                </div>
            }
            else
            {
                <div class="empty-state">
                    <p>Seleziona un'origine dati per visualizzare l'anteprima</p>
                </div>
            }
        </div>
    </div>
    
    @if (AppState.IsLoading)
    {
        <div class="loading-overlay">
            <div class="spinner"></div>
            <div class="loading-text">@AppState.StatusMessage</div>
        </div>
    }
</div>

@code {
    private bool showSqlServerDialog = false;
    private bool showExcelDialog = false;
    private bool showCsvDialog = false;
    
    private string? importWarningMessage = null;
    
    // Excel State
    private Guid pendingExcelFileId;
    private string pendingExcelFileName = "";
    
    // CSV State
    private IBrowserFile? pendingCsvFile;

    private Dictionary<string, string> pendingRenames = new();

    protected override async Task OnInitializedAsync()
    {
        // Carica le tabelle esistenti dalla sessione
        await LoadExistingTables();
    }

    private async Task LoadExistingTables()
    {
        try
        {
            var tablesInfo = await SqliteApi.GetTablesInfoAsync();
            foreach (var tableInfo in tablesInfo)
            {
                // Controlla se la tabella √® gi√† nell'AppState
                if (!AppState.DataSources.Any(ds => ds.TableAlias == tableInfo.TableName))
                {
                    var ds = new DataSource
                    {
                        Name = tableInfo.TableName,
                        Type = DataSourceType.Excel,
                        TableAlias = tableInfo.TableName,
                        RowCount = tableInfo.RowCount,
                        Columns = tableInfo.Columns,
                        IsLoaded = true,
                        State = new GridState()
                    };
                    
                    AppState.AddDataSource(ds);
                    
                    // Carica i primi dati
                    await ReloadDataSource(ds);
                }
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error loading existing tables: {ex.Message}");
        }
    }

    private void UpdateAliasValue(DataSource ds, string newValue)
    {
        if (ds.TableAlias != newValue)
        {
            if (!pendingRenames.ContainsKey(ds.Id))
            {
                pendingRenames[ds.Id] = ds.TableAlias;
            }
            ds.TableAlias = newValue;
        }
    }

    private async Task ApplyAliasChange(DataSource ds)
    {
        if (!pendingRenames.TryGetValue(ds.Id, out var oldAlias)) return;

        try
        {
            AppState.IsLoading = true;
            AppState.StatusMessage = $"Rinomina...";
            
            var success = await SqliteApi.RenameTableAsync(oldAlias, ds.TableAlias);
            if (success)
            {
                pendingRenames.Remove(ds.Id);
                AppState.StatusMessage = $"Alias aggiornato";
            }
            else
            {
                AppState.StatusMessage = "Errore rinomina";
            }
        }
        finally
        {
            AppState.IsLoading = false;
        }
    }

    // --- EXCEL ---
    private async Task HandleExcelUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;
        
        try 
        {
            AppState.IsLoading = true;
            AppState.StatusMessage = "Caricamento file...";
            
            using var stream = file.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024);
            var result = await SqliteApi.UploadTempExcelAsync(stream, file.Name);
            
            pendingExcelFileId = result.FileId;
            pendingExcelFileName = result.FileName;
            showExcelDialog = true;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Errore upload: {ex.Message}");
        }
        finally
        {
            AppState.IsLoading = false;
        }
    }
    
    private async Task OnExcelImported(UploadResult result)
    {
        showExcelDialog = false;
        AppState.IsLoading = true;
        
        // Clear previous warning
        importWarningMessage = null;
        
        try
        {
            // Show warning if present
            if (!string.IsNullOrEmpty(result.WarningMessage))
            {
                importWarningMessage = result.WarningMessage;
            }
            
            // Sync local state by fetching sample data
            await LoadDataSourceFromBackend(result);
            AppState.StatusMessage = $"Importato {result.TableName}";
        }
        finally
        {
            AppState.IsLoading = false;
        }
    }

    // --- CSV ---
    private void HandleCsvUpload(InputFileChangeEventArgs e)
    {
        pendingCsvFile = e.File;
        if (pendingCsvFile != null)
        {
            showCsvDialog = true;
        }
    }
    
    private async Task OnCsvConfirmed((string Alias, string Separator, string DateFormat, string DecimalSeparator) options)
    {
        showCsvDialog = false;
        if (pendingCsvFile == null) return;
        
        try
        {
            AppState.IsLoading = true;
            AppState.StatusMessage = "Caricamento CSV...";
            
             using var stream = pendingCsvFile.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024);
             // Use MemoryStream to avoid repeated reads issues if any
             using var ms = new MemoryStream();
             await stream.CopyToAsync(ms);
             ms.Position = 0;
             
             var result = await SqliteApi.UploadCsvAsync(ms, pendingCsvFile.Name, options.Alias, options.Separator, options.DateFormat, options.DecimalSeparator);
             
             if (result.Success)
             {
                 await LoadDataSourceFromBackend(result);
                 AppState.StatusMessage = $"Importato CSV: {result.TableName}";
             }
             else
             {
                 await JS.InvokeVoidAsync("alert", $"Errore CSV: {result.ErrorMessage}");
             }
        }
        catch (Exception ex)
        {
             await JS.InvokeVoidAsync("alert", $"Errore: {ex.Message}");
        }
        finally
        {
            AppState.IsLoading = false;
        }
    }

    // --- HELPER ---
    private async Task LoadDataSourceFromBackend(UploadResult result)
    {
        var ds = new DataSource
        {
            Name = result.TableName,
            Type = DataSourceType.Excel, // Or generic
            TableAlias = result.TableName, // Typically same
            RowCount = result.RowCount,
            Columns = result.Columns,
            IsLoaded = true,
            State = new GridState() // Init fresh state
        };
        
        AppState.AddDataSource(ds);
        
        // Initial load
        await ReloadDataSource(ds);
    }
    
    private async Task ReloadDataSource(DataSource ds)
    {
        AppState.IsLoading = true;
        try 
        {
            var sql = $"SELECT * FROM [{ds.TableAlias}]";
            var whereParts = new List<string>();
            
            foreach(var f in ds.State.Filters)
            {
                var val = f.Value.Replace("'", "''");
                switch(f.Operator)
                {
                   case "Contains": whereParts.Add($"[{f.Column}] LIKE '%{val}%'"); break;
                   case "Equals": whereParts.Add($"[{f.Column}] = '{val}'"); break;
                   case "StartsWith": whereParts.Add($"[{f.Column}] LIKE '{val}%'"); break;
                   case "EndsWith": whereParts.Add($"[{f.Column}] LIKE '%{val}'"); break;
                   case "GreaterThan": whereParts.Add($"[{f.Column}] > '{val}'"); break;
                   case "LessThan": whereParts.Add($"[{f.Column}] < '{val}'"); break;
                }
            }
            
            if(whereParts.Any())
            {
                sql += " WHERE " + string.Join(" AND ", whereParts);
            }
            
            if(!string.IsNullOrEmpty(ds.State.SortColumn))
            {
                 sql += $" ORDER BY [{ds.State.SortColumn}] {(ds.State.SortDirection == SortDirection.Ascending ? "ASC" : "DESC")}";
            }
            
            sql += " LIMIT 50";
            
            var result = await SqliteApi.ExecuteQueryAsync(sql);
            ds.Data = result.Rows.Select(r => r.ToDictionary(k => k.Key, v => v.Value?.ToString() ?? "")).ToList();
        }
        finally
        {
            AppState.IsLoading = false;
        }
    }
    
    private async Task RemoveDataSource(DataSource ds)
    {
        try
        {
            AppState.IsLoading = true;
             var success = await SqliteApi.DropTableAsync(ds.TableAlias);
             if (success)
             {
                 AppState.RemoveDataSource(ds);
             }
             else
             {
                 await JS.InvokeVoidAsync("alert", "Impossibile rimuovere tabella dal db");
             }
        }
        finally
        {
            AppState.IsLoading = false;
        }
    }
    
    private void ClearAll()
    {
        AppState.ClearAll(); // This might need backend clear too? For now keep as is.
        // Usually should drop all tables.
    }
}
